<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>생산구역 청소 체크</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:system-ui;margin:0;background:#f6f7f9}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
.card{background:#fff;border-radius:14px;border:1px solid #e6e8ec}
h1{margin:0;font-size:18px}
.header{padding:16px;border-bottom:1px solid #e6e8ec}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
.grade{background:#eef2ff;font-weight:900}
.area{background:#fafbff;font-weight:800}
.task{padding-left:32px}
button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
select{padding:6px;border-radius:8px}
</style>
</head>

<body>
<div class="wrap">
<div class="card">
<div class="header">
<h1>생산구역 청소 체크</h1>
</div>

<table>
<thead>
<tr>
<th>구성</th>
<th>상태</th>
<th>작업</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>
</div>

<script>
const supa = supabase.createClient(
  "https://lojyvnojinrsxefzrdle.supabase.co",
  "YOUR_ANON_KEY"
);

const GRADE_ORDER = ["B","C","CNC","UCA"];
let areas=[], tasks=[];

async function loadAll(){
  const a = await supa.from("cleaning_areas").select("name,grade");
  const t = await supa.from("cleaning_area_tasks").select("*");
  areas = a.data || [];
  tasks = t.data || [];
  render();
}

function render(){
  const tb = document.getElementById("tbody");
  tb.innerHTML="";

  const byGrade = {};
  areas.forEach(a=>{
    byGrade[a.grade]=byGrade[a.grade]||[];
    byGrade[a.grade].push(a);
  });

  GRADE_ORDER.forEach(g=>{
    if(!byGrade[g]) return;

    const trG = document.createElement("tr");
    trG.className="grade";
    trG.innerHTML=`<td colspan="3">Grade ${g}</td>`;
    tb.appendChild(trG);

    byGrade[g].forEach(a=>{
      const trA=document.createElement("tr");
      trA.className="area";
      trA.innerHTML=`
        <td>${a.name}</td>
        <td>
          <select onchange="changeGrade('${a.name}',this.value)">
            ${GRADE_ORDER.map(x=>`<option ${x===g?'selected':''}>${x}</option>`).join("")}
          </select>
        </td>
        <td></td>`;
      tb.appendChild(trA);

      tasks.filter(t=>t.area_name===a.name).forEach(t=>{
        const trT=document.createElement("tr");
        trT.innerHTML=`
          <td class="task">└ ${t.cycle}</td>
          <td>${t.status}</td>
          <td>
            <button onclick="setStatus('${a.name}','${t.cycle}','O')">O</button>
            <button onclick="setStatus('${a.name}','${t.cycle}','X')">X</button>
          </td>`;
        tb.appendChild(trT);
      });
    });
  });
}

async function changeGrade(name,grade){
  await supa.from("cleaning_areas").update({grade}).eq("name",name);
}

async function setStatus(name,cycle,status){
  await supa.from("cleaning_area_tasks")
    .update({status,status_changed_at:new Date().toISOString()})
    .eq("area_name",name).eq("cycle",cycle);
}

/* ===== Realtime ===== */
supa.channel("cleaning-realtime")
  .on("postgres_changes",{event:"*",schema:"public",table:"cleaning_areas"},loadAll)
  .on("postgres_changes",{event:"*",schema:"public",table:"cleaning_area_tasks"},loadAll)
  .subscribe();

loadAll();
</script>
</body>
</html>
