<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>생산구역 청소 체크</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --bg:#f6f7f9;
      --card:#fff;
      --line:#e6e8ec;
      --line2:#f0f2f5;
      --text:#111;
      --muted:#666;
      --primary:#2f6fed;
      --primary2:#2457bd;
      --ok:#2db36b;
      --ok2:#229957;
      --bad:#e05757;
      --bad2:#c94747;
    }

    body { margin: 0; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1180px; margin: 32px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); overflow:hidden; }
    .header { padding: 18px 18px 12px 18px; border-bottom:1px solid var(--line); }
    h1 { margin: 0; font-size: 18px; }
    .now-time { margin-top: 10px; font-size: 16px; font-weight: 800; color: var(--primary); }
    .sub { margin-top: 10px; font-size: 14px; color: var(--muted); line-height: 1.7; }

    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #d5d9e0; background: #fff; color: #333; font-weight: 700; }
    .top-row { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px 12px; align-items: center; }

    .controls { display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; padding: 12px 18px 18px 18px; border-bottom:1px solid var(--line); }
    input[type="text"] { height: 40px; padding: 0 12px; border: 1px solid #d5d9e0; border-radius: 10px; outline: none; }
    input[type="text"]:focus { border-color: rgba(47,111,237,.55); box-shadow: 0 0 0 4px rgba(47,111,237,.12); }

    select { height: 40px; padding: 0 10px; border: 1px solid #d5d9e0; border-radius: 10px; background: #fff; font-weight: 700; }

    button { height: 40px; padding: 0 12px; border: 1px solid #d5d9e0; background: #fff; border-radius: 10px; cursor: pointer; font-weight: 800; }
    button.primary { border-color: var(--primary); background: var(--primary); color: #fff; }
    button.primary:hover { background: var(--primary2); border-color: var(--primary2); }
    button.danger { border-color: rgba(224,87,87,.6); background: #fff; color: #b61f1f; }
    button.danger:hover { background: rgba(224,87,87,.06); border-color: rgba(224,87,87,.85); }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .content { padding: 0 18px 18px 18px; }
    .table-wrap{ border:1px solid var(--line); border-radius: 12px; overflow:auto; background:#fff; }
    table { width: 100%; border-collapse: collapse; min-width: 980px; }
    thead th { text-align: left; font-size: 12px; color: var(--muted); background: #fafbfc; border-bottom: 1px solid var(--line); padding: 10px 12px; white-space:nowrap; }
    tbody td { padding: 12px; border-bottom: 1px solid var(--line2); vertical-align: middle; }
    tbody tr:last-child td { border-bottom: none; }

    .badge { display: inline-flex; align-items: center; gap: 8px; font-weight: 900; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .x .dot { background: var(--bad); }
    .o .dot { background: var(--ok); }

    .row-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; align-items: center; }
    .muted { color: var(--muted); font-size: 12px; }
    .time-cell { font-size: 12px; color: #333; }
    .time-cell .small { display: block; font-size: 11px; color: var(--muted); margin-top: 2px; }
    .countdown-cell { font-size: 12px; font-weight: 850; color: var(--primary); white-space: nowrap; }

    button.ox { min-width: 44px; padding: 0 14px; font-weight: 950; border: 1px solid transparent; letter-spacing: .3px; color:#fff; }
    button.ox-o { background: var(--ok); border-color: var(--ok2); }
    button.ox-x { background: var(--bad); border-color: var(--bad2); }
    button.ox:disabled { opacity: .35; filter: grayscale(35%); }

    .chip { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #d5d9e0; background: #fff; font-weight: 800; }
    .mini { height: 34px; padding: 0 10px; border-radius: 10px; font-size: 12px; }
    .inline { display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    /* Grade 행 */
    tr.grade-row td {
      background: #f2f5ff;
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
    }
    .grade-bar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .grade-title{ font-weight: 950; letter-spacing: -.2px; }
    .toggle-btn{
      height: 30px; padding: 0 10px;
      border-radius: 999px; border: 1px solid #d5d9e0;
      background:#fff; cursor:pointer; font-weight: 900;
    }

    /* 구역 행 */
    tr.area-row td { background: #fbfcfe; border-bottom: 1px solid var(--line); }
    .area-title { font-weight: 950; }

    /* 하위(주기) 행 */
    tr.task-row td:first-child { padding-left: 28px; }
    .cycle-weekly { border-color: rgba(47,111,237,.35); }
    .cycle-monthly { border-color: rgba(45,179,107,.35); }
    .cycle-quarterly { border-color: rgba(224,87,87,.35); }

    .footer { padding: 0 18px 18px 18px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .toast { margin-top: 10px; font-size: 12px; color: var(--ok); display: none; font-weight:800; }
    .toast.err { color: #b61f1f; }

    @media (max-width: 980px) {
      .controls { grid-template-columns: 1fr; }
      .row-actions { justify-content: flex-start; }
      .footer { flex-direction: column; align-items: stretch; }
      table { min-width: 860px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>생산구역 청소 체크_V3</h1>
        <div id="nowTime" class="now-time">현재 시각: -</div>

        <div class="top-row">
          <div class="pill" id="syncState">동기화: -</div>
          <div class="pill" id="resetState">자동리셋: -</div>
          <div class="pill" id="lastResetLog">마지막 초기화: -</div>
          <div class="pill" id="rtState">실시간: -</div>
          <div class="pill" id="buildInfo">버전: -</div>
        </div>

        <div class="sub">
          최상위는 <b>Grade</b>이며, 그 아래에 구역과 주기(주간/월간/분기) 항목이 표시됩니다.<br/>
        </div>

        <div id="toast" class="toast"></div>
      </div>

      <div class="controls">
        <input id="areaInput" type="text" placeholder="구역 추가 (예: 준비실)" />
        <select id="gradeInput">
          <option value="B">Grade B</option>
          <option value="C">Grade C</option>
          <option value="CNC">Grade CNC</option>
          <option value="UCA">Grade UCA</option>
        </select>
        <button id="addAreaBtn" class="primary">구역 추가</button>
        <button id="resetCatchUpBtn" class="danger">전체 리셋</button>
      </div>

      <div class="content">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width: 34%;">Grade / 구역 / 주기</th>
                <th style="width: 10%;">상태</th>
                <th style="width: 16%;">다음 리셋까지</th>
                <th style="width: 20%;">상태 변경 시점</th>
                <th style="width: 20%; text-align:right;">선택</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        <div class="muted">공유 저장소: Supabase</div>
        <div class="muted" id="summaryLabel">항목 0개 (O: 0 / X: 0)</div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // =========================
      // Supabase 설정값 입력
      // =========================
      const SUPABASE_URL = "https://lojyvnojinrsxefzrdle.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxvanl2bm9qaW5yc3hlZnpyZGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODQxNzQsImV4cCI6MjA4NDM2MDE3NH0.UEiP64KmASkhKP6ufxxWlSLUlCqhJjkL1TtDA2Ob1-0";

      const BUILD_VERSION = "2026-01-23.v2.grade-group+collapse+realtime";

      const buildInfoEl = document.getElementById("buildInfo");
      buildInfoEl.textContent = "버전: " + BUILD_VERSION;

      if (!SUPABASE_URL || SUPABASE_URL.includes("YOUR_SUPABASE_URL_HERE") ||
          !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("YOUR_SUPABASE_ANON_KEY_HERE")) {
        alert("SUPABASE_URL / SUPABASE_ANON_KEY를 먼저 입력하세요. (Supabase Settings → API)");
      }

      const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Elements
      const toastEl = document.getElementById("toast");
      const nowTimeEl = document.getElementById("nowTime");
      const syncStateEl = document.getElementById("syncState");
      const resetStateEl = document.getElementById("resetState");
      const lastResetLogEl = document.getElementById("lastResetLog");
      const rtStateEl = document.getElementById("rtState");

      const tbody = document.getElementById("tbody");
      const summaryLabel = document.getElementById("summaryLabel");

      const areaInput = document.getElementById("areaInput");
      const gradeInput = document.getElementById("gradeInput");
      const addAreaBtn = document.getElementById("addAreaBtn");
      const resetCatchUpBtn = document.getElementById("resetCatchUpBtn");

      const ALLOWED_GRADES = ["B","C","CNC","UCA"];
      const GRADE_ORDER = ["B","C","CNC","UCA"];

      // ===== Grade collapse state (localStorage) =====
      const LS_KEY = "cleaning_grade_collapsed_v1";
      function loadCollapsedMap() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          const obj = raw ? JSON.parse(raw) : {};
          return (obj && typeof obj === "object") ? obj : {};
        } catch (_) {
          return {};
        }
      }
      function saveCollapsedMap(map) {
        try { localStorage.setItem(LS_KEY, JSON.stringify(map)); } catch (_) {}
      }
      let collapsedByGrade = loadCollapsedMap();

      // Toast
      let toastTimer = null;
      function toast(msg, isError = false) {
        toastEl.textContent = msg;
        toastEl.className = "toast" + (isError ? " err" : "");
        toastEl.style.display = "block";
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => { toastEl.style.display = "none"; }, 2300);
      }
      function setSyncState(text) { syncStateEl.textContent = "동기화: " + text; }
      function setResetState(text) { resetStateEl.textContent = "자동리셋: " + text; }
      function setRtState(text) { rtStateEl.textContent = "실시간: " + text; }

      // UI lock (버튼 잠금이 너무 길어지는 문제 방지)
      async function withLock(el, fn, cooldownMs = 250) {
        if (!el || el.disabled) return;
        el.disabled = true;
        try { await fn(); }
        finally { setTimeout(() => { el.disabled = false; }, cooldownMs); }
      }

      // KST formatters
      const fmtNowKst = new Intl.DateTimeFormat("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric", month: "2-digit", day: "2-digit",
        weekday: "short",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false,
      });

      const fmtKstDateTime = new Intl.DateTimeFormat("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false,
      });

      function tickNow() {
        nowTimeEl.textContent = "현재 시각: " + fmtNowKst.format(new Date());
      }

      // ===== normalize =====
      function normName(s) {
        let v = String(s ?? "");
        v = v.replace(/\u00A0/g, " ").replace(/\u2009/g, " ").replace(/\u2002|\u2003/g, " ");
        try { v = v.normalize("NFKC"); } catch (_) {}
        return v.trim().replace(/\s+/g, " ");
      }
      function normGrade(g) {
        const v = String(g ?? "").trim().toUpperCase();
        return ALLOWED_GRADES.includes(v) ? v : "B";
      }

      // ===== KST date parts / reset =====
      function getKstParts(date = new Date()) {
        const fmt = new Intl.DateTimeFormat("en-CA", {
          timeZone: "Asia/Seoul",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          weekday: "short",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        });
        const parts = fmt.formatToParts(date);
        const map = {};
        parts.forEach(p => { if (p.type !== "literal") map[p.type] = p.value; });
        return { y: Number(map.year), m: Number(map.month), d: Number(map.day), weekday: map.weekday };
      }

      function kstToUtcMs(y, m, d, hh = 0, mm = 0, ss = 0) {
        return Date.UTC(y, m - 1, d, hh - 9, mm, ss);
      }

      function nextResetUtcMsByCycle(cycle, now = new Date()) {
        const p = getKstParts(now);
        const dowMap = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };
        const dow = dowMap[p.weekday] ?? 0;

        if (cycle === "weekly") {
          const daysToNextMon = (8 - dow) % 7 || 7; // 다음 월요일
          const baseUtc = kstToUtcMs(p.y, p.m, p.d, 0, 0, 0);
          return baseUtc + daysToNextMon * 86400000;
        }
        if (cycle === "monthly") {
          let ny = p.y;
          let nm = p.m + 1;
          if (nm === 13) { nm = 1; ny += 1; }
          return kstToUtcMs(ny, nm, 1, 0, 0, 0);
        }
        // quarterly
        const qStartMonth = p.m <= 3 ? 1 : p.m <= 6 ? 4 : p.m <= 9 ? 7 : 10;
        let nextQMonth = qStartMonth + 3;
        let ny = p.y;
        if (nextQMonth === 13) { nextQMonth = 1; ny += 1; }
        return kstToUtcMs(ny, nextQMonth, 1, 0, 0, 0);
      }

      function formatCountdown(ms) {
        const totalSec = Math.max(0, Math.floor(ms / 1000));
        const days = Math.floor(totalSec / 86400);
        const rem1 = totalSec % 86400;
        const hh = String(Math.floor(rem1 / 3600)).padStart(2, "0");
        const rem2 = rem1 % 3600;
        const mm = String(Math.floor(rem2 / 60)).padStart(2, "0");
        const ss = String(rem2 % 60).padStart(2, "0");
        return days > 0 ? `${days}일 ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
      }

      function kstText(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "—";
        return fmtKstDateTime.format(d);
      }

      // ===== Data =====
      let areas = []; // [{name, grade}]
      let tasks = []; // [{area_name, cycle, status, status_changed_at}]

      function cycleRank(c) { return c === "weekly" ? 0 : c === "monthly" ? 1 : 2; }
      function cycleLabel(c) { return c === "weekly" ? "주간" : c === "monthly" ? "월간" : "분기"; }
      function cycleChipClass(c) { return c === "weekly" ? "cycle-weekly" : c === "monthly" ? "cycle-monthly" : "cycle-quarterly"; }

      // =========================
      // Fetch
      // =========================
      async function fetchAreas() {
        const { data, error } = await supa
          .from("cleaning_areas")
          .select("name, grade")
          .order("name", { ascending: true });

        if (error) throw error;

        areas = (data || []).map(r => ({
          name: normName(r.name),
          grade: normGrade(r.grade ?? "B"),
        }));
      }

      async function fetchTasks() {
        const { data, error } = await supa
          .from("cleaning_area_tasks")
          .select("area_name,cycle,status,status_changed_at")
          .order("area_name", { ascending: true });

        if (error) throw error;

        tasks = (data || []).map(t => ({
          ...t,
          area_name: normName(t.area_name),
        })).sort((a, b) => {
          const na = a.area_name.localeCompare(b.area_name, "ko");
          if (na !== 0) return na;
          return cycleRank(a.cycle) - cycleRank(b.cycle);
        });
      }

      async function fetchLastResetLog() {
        const { data, error } = await supa
          .from("cleaning_reset_logs")
          .select("reset_at")
          .order("reset_at", { ascending: false })
          .limit(1);

        if (error || !data || data.length === 0) {
          lastResetLogEl.textContent = "마지막 초기화: -";
          return;
        }
        const d = new Date(data[0].reset_at);
        lastResetLogEl.textContent = "마지막 초기화: " + (isNaN(d.getTime()) ? "-" : fmtKstDateTime.format(d));
      }

      // =========================
      // RPC: Reset catch-up
      // =========================
      async function runResetCatchUpOnce(btnEl) {
        await withLock(btnEl, async () => {
          setResetState("체크 중...");
          const { data, error } = await supa.rpc("reset_due_tasks_kst");
          if (error) {
            setResetState("오류");
            toast("리셋 체크 실패: " + error.message, true);
            return;
          }
          const affected = Number(data || 0);
          setResetState(affected > 0 ? `리셋 ${affected}건` : "변경 없음");
          await fetchLastResetLog();
          if (affected > 0) loadAllAsync();
        }, 500);
      }

      // =========================
      // Mutations
      // =========================
      async function addArea(name, grade, btnEl) {
        const clean = normName(name);
        const g = normGrade(grade);
        if (!clean) return toast("구역 이름을 입력하세요.", true);

        await withLock(btnEl, async () => {
          setSyncState("저장 중...");
          const { error } = await supa.from("cleaning_areas").insert([{ name: clean, grade: g }]);
          if (error) { setSyncState("오류"); toast("구역 추가 실패: " + error.message, true); return; }
          setSyncState("정상");
          toast(`'${clean}' 구역이 추가되었습니다. (Grade: ${g})`);
          loadAllAsync();
        });
      }

      async function updateAreaGrade(areaName, newGrade, selectEl) {
        const clean = normName(areaName);
        const g = normGrade(newGrade);

        await withLock(selectEl, async () => {
          setSyncState("저장 중...");
          const { error } = await supa
            .from("cleaning_areas")
            .update({ grade: g })
            .eq("name", clean);

          if (error) { setSyncState("오류"); toast("Grade 변경 실패: " + error.message, true); return; }

          // 즉시 UI 반영(낙관적 업데이트)
          const a = areas.find(x => x.name === clean);
          if (a) a.grade = g;

          setSyncState("정상");
          toast(`'${clean}' Grade가 ${g}로 변경되었습니다.`);
          render();
          // Realtime으로 다른 클라이언트도 반영됨
        }, 200);
      }

      async function deleteArea(name, btnEl) {
        const clean = normName(name);
        await withLock(btnEl, async () => {
          setSyncState("저장 중...");
          const { error } = await supa.from("cleaning_areas").delete().eq("name", clean);
          if (error) { setSyncState("오류"); toast("구역 삭제 실패: " + error.message, true); return; }
          setSyncState("정상");
          toast(`'${clean}' 구역이 삭제되었습니다.`);
          loadAllAsync();
        }, 450);
      }

      async function addTask(areaName, cycle, btnEl) {
        const clean = normName(areaName);
        await withLock(btnEl, async () => {
          setSyncState("저장 중...");
          const isoNow = new Date().toISOString();
          const { error } = await supa
            .from("cleaning_area_tasks")
            .insert([{ area_name: clean, cycle, status: "X", status_changed_at: isoNow }]);
          if (error) { setSyncState("오류"); toast("주기 항목 추가 실패: " + error.message, true); return; }
          setSyncState("정상");
          toast(`'${clean}'에 ${cycleLabel(cycle)} 항목이 추가되었습니다.`);
          loadAllAsync();
        });
      }

      async function deleteTask(areaName, cycle, btnEl) {
        const clean = normName(areaName);
        await withLock(btnEl, async () => {
          setSyncState("저장 중...");
          const { error } = await supa
            .from("cleaning_area_tasks")
            .delete()
            .eq("area_name", clean)
            .eq("cycle", cycle);
          if (error) { setSyncState("오류"); toast("주기 항목 삭제 실패: " + error.message, true); return; }
          setSyncState("정상");
          toast(`'${clean}' ${cycleLabel(cycle)} 항목이 삭제되었습니다.`);
          loadAllAsync();
        }, 450);
      }

      async function setStatus(areaName, cycle, status, btnEl) {
        const clean = normName(areaName);
        await withLock(btnEl, async () => {
          setSyncState("저장 중...");
          const isoNow = new Date().toISOString();
          const { error } = await supa
            .from("cleaning_area_tasks")
            .update({ status, status_changed_at: isoNow })
            .eq("area_name", clean)
            .eq("cycle", cycle);
          if (error) { setSyncState("오류"); toast("상태 변경 실패: " + error.message, true); return; }
          setSyncState("정상");
          loadAllAsync();
        }, 200);
      }

      // =========================
      // Render
      // =========================
      function updateSummary() {
        const oCount = tasks.filter(t => t.status === "O").length;
        const xCount = tasks.filter(t => t.status === "X").length;
        summaryLabel.textContent = `항목 ${tasks.length}개 (O: ${oCount} / X: ${xCount})`;
      }

      function renderGradeRow(grade, areaCount, collapsed) {
        const tr = document.createElement("tr");
        tr.className = "grade-row";

        const td = document.createElement("td");
        td.colSpan = 5;

        const bar = document.createElement("div");
        bar.className = "grade-bar";

        const left = document.createElement("div");
        left.className = "inline";
        const title = document.createElement("span");
        title.className = "grade-title";
        title.textContent = `Grade ${grade}`;
        const cnt = document.createElement("span");
        cnt.className = "muted";
        cnt.textContent = `구역 ${areaCount}개`;

        left.appendChild(title);
        left.appendChild(cnt);

        const btn = document.createElement("button");
        btn.className = "toggle-btn";
        btn.textContent = collapsed ? "펼치기 ▾" : "접기 ▴";
        btn.addEventListener("click", () => {
          collapsedByGrade[grade] = !collapsedByGrade[grade];
          saveCollapsedMap(collapsedByGrade);
          render();
        });

        bar.appendChild(left);
        bar.appendChild(btn);
        td.appendChild(bar);
        tr.appendChild(td);
        return tr;
      }

      function render() {
        tbody.innerHTML = "";

        if (!areas.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.className = "muted";
          td.style.padding = "16px 12px";
          td.textContent = "등록된 구역이 없습니다. 상단에서 구역을 추가하세요.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateSummary();
          return;
        }

        // grade -> areas group
        const byGrade = {};
        for (const a of areas) {
          const g = normGrade(a.grade);
          if (!byGrade[g]) byGrade[g] = [];
          byGrade[g].push(a);
        }
        for (const g of Object.keys(byGrade)) {
          byGrade[g].sort((x, y) => x.name.localeCompare(y.name, "ko"));
        }

        const now = new Date();

        for (const grade of GRADE_ORDER) {
          const gradeAreas = byGrade[grade];
          if (!gradeAreas || gradeAreas.length === 0) continue;

          const collapsed = !!collapsedByGrade[grade];
          tbody.appendChild(renderGradeRow(grade, gradeAreas.length, collapsed));
          if (collapsed) continue;

          for (const area of gradeAreas) {
            const areaName = area.name;

            const areaTasks = tasks
              .filter(t => t.area_name === areaName)
              .sort((a, b) => cycleRank(a.cycle) - cycleRank(b.cycle));

            // Area row
            const areaTr = document.createElement("tr");
            areaTr.className = "area-row";

            const tdArea = document.createElement("td");
            tdArea.colSpan = 5;

            const wrap = document.createElement("div");
            wrap.className = "inline";
            wrap.style.justifyContent = "space-between";
            wrap.style.width = "100%";

            const left = document.createElement("div");
            left.className = "inline";

            const title = document.createElement("span");
            title.className = "area-title";
            title.textContent = areaName;

            const gradeSel = document.createElement("select");
            gradeSel.className = "mini";
            gradeSel.innerHTML = `
              <option value="B">Grade B</option>
              <option value="C">Grade C</option>
              <option value="CNC">Grade CNC</option>
              <option value="UCA">Grade UCA</option>
            `;
            gradeSel.value = grade;
            gradeSel.addEventListener("change", () => updateAreaGrade(areaName, gradeSel.value, gradeSel));

            left.appendChild(title);
            left.appendChild(gradeSel);

            const right = document.createElement("div");
            right.className = "inline";

            const addSel = document.createElement("select");
            addSel.className = "mini";
            addSel.innerHTML = `
              <option value="weekly">주간 추가</option>
              <option value="monthly">월간 추가</option>
              <option value="quarterly">분기 추가</option>
            `;

            const addBtn = document.createElement("button");
            addBtn.className = "mini primary";
            addBtn.textContent = "주기 항목 추가";
            addBtn.addEventListener("click", () => addTask(areaName, addSel.value, addBtn));

            const delAreaBtn = document.createElement("button");
            delAreaBtn.className = "mini danger";
            delAreaBtn.textContent = "구역 삭제";
            delAreaBtn.addEventListener("click", () => {
              const ok = confirm(`'${areaName}' 구역을 삭제할까요? (해당 구역의 주기 항목도 모두 삭제됩니다)`);
              if (!ok) return;
              deleteArea(areaName, delAreaBtn);
            });

            right.appendChild(addSel);
            right.appendChild(addBtn);
            right.appendChild(delAreaBtn);

            wrap.appendChild(left);
            wrap.appendChild(right);

            tdArea.appendChild(wrap);
            areaTr.appendChild(tdArea);
            tbody.appendChild(areaTr);

            // No tasks
            if (areaTasks.length === 0) {
              const tr = document.createElement("tr");
              tr.className = "task-row";
              const td = document.createElement("td");
              td.colSpan = 5;
              td.className = "muted";
              td.style.padding = "12px";
              td.textContent = "이 구역에는 아직 주기 항목이 없습니다. 위에서 주기 항목을 추가하세요.";
              tr.appendChild(td);
              tbody.appendChild(tr);
              continue;
            }

            // Task rows
            for (const t of areaTasks) {
              const tr = document.createElement("tr");
              tr.className = "task-row";

              const tdName = document.createElement("td");
              const nameWrap = document.createElement("div");
              nameWrap.className = "inline";

              const arrow = document.createElement("span");
              arrow.textContent = "└";

              const cycleChip = document.createElement("span");
              cycleChip.className = "chip " + cycleChipClass(t.cycle);
              cycleChip.textContent = cycleLabel(t.cycle);

              nameWrap.appendChild(arrow);
              nameWrap.appendChild(cycleChip);
              tdName.appendChild(nameWrap);

              const tdStatus = document.createElement("td");
              const badge = document.createElement("span");
              badge.className = "badge " + (t.status === "O" ? "o" : "x");
              const dot = document.createElement("span");
              dot.className = "dot";
              const st = document.createElement("span");
              st.textContent = t.status;
              badge.appendChild(dot);
              badge.appendChild(st);
              tdStatus.appendChild(badge);

              const tdCd = document.createElement("td");
              tdCd.className = "countdown-cell";
              tdCd.dataset.cycle = t.cycle;
              const nextUtc = nextResetUtcMsByCycle(t.cycle, now);
              tdCd.textContent = formatCountdown(nextUtc - now.getTime());

              const tdChanged = document.createElement("td");
              tdChanged.className = "time-cell";
              tdChanged.textContent = kstText(t.status_changed_at);
              const sub = document.createElement("span");
              sub.className = "small";
              sub.textContent = "KST 기준";
              tdChanged.appendChild(sub);

              const tdAct = document.createElement("td");
              const actWrap = document.createElement("div");
              actWrap.className = "row-actions";

              const oBtn = document.createElement("button");
              oBtn.className = "ox ox-o";
              oBtn.textContent = "O";
              oBtn.disabled = (t.status === "O");
              oBtn.addEventListener("click", () => setStatus(t.area_name, t.cycle, "O", oBtn));

              const xBtn = document.createElement("button");
              xBtn.className = "ox ox-x";
              xBtn.textContent = "X";
              xBtn.disabled = (t.status === "X");
              xBtn.addEventListener("click", () => setStatus(t.area_name, t.cycle, "X", xBtn));

              const delTaskBtn = document.createElement("button");
              delTaskBtn.className = "danger";
              delTaskBtn.textContent = "항목 삭제";
              delTaskBtn.addEventListener("click", () => {
                const ok = confirm(`'${areaName}' ${cycleLabel(t.cycle)} 항목을 삭제할까요?`);
                if (!ok) return;
                deleteTask(areaName, t.cycle, delTaskBtn);
              });

              actWrap.appendChild(oBtn);
              actWrap.appendChild(xBtn);
              actWrap.appendChild(delTaskBtn);
              tdAct.appendChild(actWrap);

              tr.appendChild(tdName);
              tr.appendChild(tdStatus);
              tr.appendChild(tdCd);
              tr.appendChild(tdChanged);
              tr.appendChild(tdAct);
              tbody.appendChild(tr);
            }
          }
        }

        updateSummary();
      }

      // 카운트다운만 업데이트(테이블 전체 rerender 금지)
      function tickCountdownOnly() {
        const now = new Date();
        const cells = document.querySelectorAll('td.countdown-cell[data-cycle]');
        for (const cell of cells) {
          const cycle = cell.dataset.cycle;
          const nextUtc = nextResetUtcMsByCycle(cycle, now);
          cell.textContent = formatCountdown(nextUtc - now.getTime());
        }
      }

      // =========================
      // Load (중복/폭주 방지)
      // =========================
      let loadSeq = 0;
      async function loadAll() {
        const seq = ++loadSeq;
        try {
          setSyncState("불러오는 중...");
          await fetchAreas();
          await fetchTasks();
          if (seq !== loadSeq) return;
          setSyncState("정상");
          render();
        } catch (e) {
          if (seq !== loadSeq) return;
          setSyncState("오류");
          toast("데이터 로드 실패: " + (e?.message ?? String(e)), true);
        }
      }
      function loadAllAsync() { Promise.resolve().then(loadAll); }

      // =========================
      // Realtime (실시간 동기화)
      // =========================
      let rtChannel = null;
      function setupRealtime() {
        setRtState("연결 중...");
        rtChannel = supa
          .channel("cleaning-realtime-v1")
          .on("postgres_changes", { event: "*", schema: "public", table: "cleaning_areas" }, () => {
            loadAllAsync();
          })
          .on("postgres_changes", { event: "*", schema: "public", table: "cleaning_area_tasks" }, () => {
            loadAllAsync();
          })
          .on("postgres_changes", { event: "insert", schema: "public", table: "cleaning_reset_logs" }, () => {
            fetchLastResetLog().catch(() => {});
          })
          .subscribe((status) => {
            // status: SUBSCRIBED / CHANNEL_ERROR / TIMED_OUT / CLOSED
            if (status === "SUBSCRIBED") setRtState("정상");
            else if (status === "TIMED_OUT") setRtState("지연");
            else if (status === "CHANNEL_ERROR") setRtState("오류");
            else if (status === "CLOSED") setRtState("종료");
            else setRtState(status);
          });

        window.addEventListener("beforeunload", () => {
          try { if (rtChannel) supa.removeChannel(rtChannel); } catch (_) {}
        });
      }

      // =========================
      // Boot
      // =========================
      function handleAddArea() {
        const name = normName(areaInput.value || "");
        const grade = normGrade(gradeInput.value);
        if (!name) return toast("구역 이름을 입력하세요.", true);
        areaInput.value = "";
        addArea(name, grade, addAreaBtn);
      }

      addAreaBtn.addEventListener("click", handleAddArea);
      areaInput.addEventListener("keydown", (e) => { if (e.key === "Enter") handleAddArea(); });

      resetCatchUpBtn.addEventListener("click", () => runResetCatchUpOnce(resetCatchUpBtn));

      async function boot() {
        tickNow();
        setInterval(tickNow, 1000);

        // 접속 시 1회 캐치업(백그라운드)
        runResetCatchUpOnce(resetCatchUpBtn).catch(() => {});

        loadAllAsync();
        fetchLastResetLog().catch(() => {});

        setupRealtime();
        setInterval(tickCountdownOnly, 1000);
      }

      boot();
    })();
  </script>
</body>
</html>


